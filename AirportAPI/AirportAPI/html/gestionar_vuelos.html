<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Vuelos</title>
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="utiles/bootstrap-5.3.3-dist/css/bootstrap.min.css"
    />
    <script src="utiles/bootstrap-5.3.3-dist/js/bootstrap.min.js"></script>
    <script src="main.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center">Gestión de Vuelos</h1>
      <div class="d-flex justify-content-between">
        <button
          type="button"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addFlightModal"
        >
          Añadir Vuelo
        </button>
        <button
          type="button"
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#searchFlightModal"
        >
          Buscar Vuelos
        </button>
      </div>
      <table class="table table-striped mt-3">
        <thead>
          <tr>
            <th>ID Vuelo</th>
            <th>Fecha de Partida</th>
            <th>Fecha de Llegada</th>
            <th>País de Origen</th>
            <th>País Destino</th>
            <th>Modelo de Avión</th>
            <th>Capacidad Máx</th>
            <th>Cantidad de Pasajes Disponibles</th>
          </tr>
        </thead>
        <tbody id="flightTableBody">
          <!-- Los datos se añadirán aquí dinámicamente -->
        </tbody>
      </table>
    </div>

    <!-- Modal para Añadir Vuelo -->
    <div
      class="modal fade"
      id="addFlightModal"
      tabindex="-1"
      aria-labelledby="addFlightModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addFlightModalLabel">Añadir Vuelo</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="addFlightForm">
            <div class="modal-body">
              <!-- Campos del formulario para añadir vuelos -->
              <div class="mb-3">
                <label for="flightId" class="form-label">ID Vuelo:</label>
                <input
                  type="text"
                  class="form-control"
                  id="flightId"
                  name="flightId"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="departureDate" class="form-label"
                  >Fecha de Partida:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="departureDate"
                  name="departureDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="arrivalDate" class="form-label"
                  >Fecha de Llegada:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="arrivalDate"
                  name="arrivalDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="originCountry" class="form-label"
                  >País de Origen:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="originCountry"
                  name="originCountry"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="destinationCountry" class="form-label"
                  >País Destino:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="destinationCountry"
                  name="destinationCountry"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="airplaneModel" class="form-label"
                  >Modelo de Avión:</label
                >
                <select
                  class="form-control"
                  id="airplaneModel"
                  name="airplaneModel"
                  required
                >
                  <option value="">Selecciona un modelo</option>
                  <option value="Boeing 747">Boeing 747</option>
                  <option value="Airbus A380">Airbus A380</option>
                  <option value="Boeing 777">Boeing 777</option>
                  <option value="Airbus A320">Airbus A320</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="maxCapacity" class="form-label"
                  >Capacidad Máx:</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="maxCapacity"
                  name="maxCapacity"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="availablePassengers" class="form-label"
                  >Cantidad de Pasajes Disponibles:</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="availablePassengers"
                  name="availablePassengers"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cerrar
              </button>
              <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Buscar Vuelos -->
    <div
      class="modal fade"
      id="searchFlightModal"
      tabindex="-1"
      aria-labelledby="searchFlightModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="searchFlightModalLabel">
              Buscar Vuelos
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="searchFlightForm">
            <div class="modal-body">
              <!-- Campos del formulario para buscar vuelos -->
              <div class="mb-3">
                <label for="searchDepartureDate" class="form-label"
                  >Fecha de Partida:</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="searchDepartureDate"
                  name="searchDepartureDate"
                />
              </div>
              <div class="mb-3">
                <label for="searchOriginCountry" class="form-label"
                  >País de Origen:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="searchOriginCountry"
                  name="searchOriginCountry"
                />
              </div>
              <div class="mb-3">
                <label for="searchDestinationCountry" class="form-label"
                  >País Destino:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="searchDestinationCountry"
                  name="searchDestinationCountry"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cerrar
              </button>
              <button type="submit" class="btn btn-primary">Buscar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
      $(document).ready(function () {
        // Validación y manejo del formulario de añadir vuelo
        $("#addFlightForm").validate({
          rules: {
            flightId: {
              required: true,
              minlength: 2,
            },
            departureDate: {
              required: true,
              date: true,
            },
            arrivalDate: {
              required: true,
              date: true,
            },
            originCountry: {
              required: true,
              minlength: 2,
            },
            destinationCountry: {
              required: true,
              minlength: 2,
            },
            airplaneModel: {
              required: true,
            },
            maxCapacity: {
              required: true,
              min: 1,
            },
            availablePassengers: {
              required: true,
              min: 0,
              max: function () {
                return $("#maxCapacity").val();
              },
            },
          },
          messages: {
            flightId: {
              required: "Por favor, introduce un ID de vuelo.",
              minlength: "El ID de vuelo debe tener al menos 2 caracteres.",
            },
            departureDate: {
              required: "Por favor, selecciona una fecha de partida.",
              date: "Por favor, introduce una fecha válida.",
            },
            arrivalDate: {
              required: "Por favor, selecciona una fecha de llegada.",
              date: "Por favor, introduce una fecha válida.",
            },
            originCountry: {
              required: "Por favor, introduce un país de origen.",
              minlength: "El país de origen debe tener al menos 2 caracteres.",
            },
            destinationCountry: {
              required: "Por favor, introduce un país de destino.",
              minlength: "El país de destino debe tener al menos 2 caracteres.",
            },
            airplaneModel: {
              required: "Por favor, selecciona un modelo de avión.",
            },
            maxCapacity: {
              required: "Por favor, introduce la capacidad máxima.",
              min: "La capacidad máxima debe ser al menos 1.",
            },
            availablePassengers: {
              required:
                "Por favor, introduce la cantidad de pasajes disponibles.",
              min: "La cantidad de pasajes disponibles debe ser al menos 0.",
              max: "La cantidad de pasajes disponibles no puede ser mayor que la capacidad máxima.",
            },
          },
          submitHandler: function (form) {
            addFlightToTable(form);
          },
        });

        // Validación y manejo del formulario de búsqueda de vuelos
        $("#searchFlightForm").validate({
          rules: {
            searchDepartureDate: {
              date: true,
            },
            searchOriginCountry: {
              minlength: 2,
            },
            searchDestinationCountry: {
              minlength: 2,
            },
          },
          messages: {
            searchDepartureDate: {
              date: "Por favor, introduce una fecha válida.",
            },
            searchOriginCountry: {
              minlength: "El país de origen debe tener al menos 2 caracteres.",
            },
            searchDestinationCountry: {
              minlength: "El país de destino debe tener al menos 2 caracteres.",
            },
          },
          submitHandler: function (form) {
            searchFlights(form);
          },
        });

        function addFlightToTable(form) {
			form.preventDefault(); // Evita el envío del formulario por defecto
			
			var flightData = {};

			$.ajax({
				url: 'http://localhost:10000/api/flight',
				method: 'POST', 
				dataType: 'json',
				contentType: 'application/json',
				data: JSON.stringify({
					Id: 0,
					FlightId:          $("#flightId").val(),
					DepartureDate:     $("#departureDate").val(),
					ArrivalDate:       $("#arrivalDate").val(),
					OriginCountry:     $("#originCountry").val(),
					DestinationCountry:$("#destinationCountry").val(),
					AircraftModel:     $("#airplaneModel").val(),
					MaxSeats:          $("#maxCapacity").val(),
					AvailableSeats:    $("#availablePassengers").val(),				
				}),
				success: function(response) {
					// Code to handle successful response
					console.log(response);
	
					
					// Añade el nuevo vuelo a la tabla
					var newRow = `<tr>
									<td>${response.FlightId}</td>
									<td>${response.DepartureDate}</td>
									<td>${response.ArrivalDate}</td>
									<td>${response.OriginCountry}</td>
									<td>${response.DestinationCountry}</td>
									<td>${response.AircraftModel}</td>
									<td>${response.MaxSeats}</td>
									<td>${response.AvailableSeats}</td>
								  </tr>`;
					
					 $("#flightTableBody").append(newRow);
				},
				error: function(xhr, status, error) {
					// Code to handle errors
					console.error(error);
				}
			});
        }

        function searchFlights(form) {
 
		  var departureDate = $("#searchDepartureDate").val();
		  var searchOriginCountry = $("#searchOriginCountry").val();
		  var searchDestinationCountry = $("#searchDestinationCountry").val();
		  
          $.ajax({
            type: "GET",
            url: `http://localhost:10000/api/flight/${departureDate}/${searchOriginCountry}/${searchDestinationCountry}`, // Actualiza esta ruta según tu configuración
            success: function (response) {
              // Limpia la tabla antes de añadir los nuevos resultados
              $("#flightTableBody").empty();

              // Añade los vuelos encontrados a la tabla
              response.forEach(function (flight) {
                var row = `<tr>
                                <td>${response.FlightId}</td>
                                <td>${response.DepartureDate}</td>
                                <td>${response.ArrivalDate}</td>
                                <td>${response.OriginCountry}</td>
                                <td>${response.DestinationCountry}</td>
                                <td>${response.AircraftModel}</td>
                                <td>${response.MaxSeats}</td>
                                <td>${response.AvailableSeats}</td>
                            </tr>`;
                $("#flightTableBody").append(row);
              });
            },
            error: function (error) {
              console.error("Error al buscar vuelos:", error);
            },
          });
        }
      });
    </script>
  </body>
</html>
